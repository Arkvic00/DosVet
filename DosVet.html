<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Dosis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 1. A√±adir CSS para el buscador de medicamentos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .result-card {
            transition: all 0.3s ease-in-out;
            transform: scale(0.95);
            opacity: 0;
        }
        .result-card.show {
            transform: scale(1);
            opacity: 1;
        }
        .medication-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        /* Estilos para el buscador */
        .choices__inner {
            background-color: white;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            font-size: 1.125rem;
            line-height: 1.75rem;
            padding: 0.625rem;
        }
        .choices[data-type*="select-one"].is-open .choices__inner {
            border-color: #6366f1;
            border-radius: 0.5rem;
        }
        .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background-color: #6366f1;
        }
        /* Estilos para el modal */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
        
        <!-- Encabezado -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-slate-800">Calculadora de Dosis</h1>
            <p class="text-slate-500 mt-1">By: Arturo Alvarado</p>
        </div>

        <!-- Panel de Control Principal -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-4">
            <div>
                <label for="especie" class="block text-sm font-medium text-slate-700">1. Especie</label>
                <select id="especie" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg p-2.5">
                    <option value="">Seleccione...</option>
                    <option value="Perro">üêï Perro</option>
                    <option value="Gato">üêà Gato</option>
                    <option value="Caballo">üêé Caballo</option>
                    <option value="Borrego">üêë Borrego</option>
                    <option value="Cabra">üêê Cabra</option>
                </select>
            </div>
            <div>
                <label for="peso" class="block text-sm font-medium text-slate-700">2. Peso (kg)</label>
                <input type="number" id="peso" placeholder="Ej: 25" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-lg p-2.5">
            </div>
        </div>

        <!-- Contenedor para Medicamentos y Bot√≥n -->
        <div id="medications-container">
            <!-- Las secciones de medicamentos y el bot√≥n se a√±adir√°n aqu√≠ -->
        </div>
    </div>
    
    <!-- Modal para resultados de Gemini -->
    <div id="gemini-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-overlay">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col modal-content">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modal-title" class="text-xl font-semibold text-slate-800"></h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <!-- Contenido generado por IA -->
            </div>
        </div>
    </div>


<!-- 2. A√±adir JS para el buscador de medicamentos -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<script>
// --- PARTE 1: La Base de Datos (El "Cerebro") ---
const database = [
    { id: 1, nombre: "Aminoforte F", principio: "Amino√°cidos/Vitaminas/Electrolitos", aplicaA: "Perro,Gato,Caballo,Borrego,Cabra", caso: "Fuente de nutrientes", min: 0.2, rec: 0.2, max: 0.2, conc: 1, unidadConc: "ml/kg", via: "IM, SC, IV", frec: "Cada 24 h", duracion: "Hasta recuperaci√≥n", notas: "La dosis es por volumen (1ml cada 5kg = 0.2ml/kg).", efectoMin: "Soporte", efectoRec: "Soporte", efectoMax: "Soporte" },
    { id: 2, nombre: "Amoxicilina", principio: "Amoxicilina", aplicaA: "Perro,Gato,Caballo,Borrego,Cabra", caso: "Infecciones", min: 15, rec: 22, max: 22, conc: 150, unidadConc: "mg/ml", via: "IM, SC", frec: "Cada 24 h", duracion: "7 a 14 d√≠as", notas: "Agitar bien la suspensi√≥n antes de usar. Respetar tiempo de retiro en animales de producci√≥n.", efectoMin: "Tratamiento", efectoRec: "Tratamiento", efectoMax: "Tratamiento" },
    { id: 3, nombre: "Antivon Vet (Pisa)", principio: "Ondansetr√≥n", aplicaA: "Perro,Gato", caso: "Control de v√≥mito", min: 0.1, rec: 0.15, max: 0.2, conc: 2, unidadConc: "mg/ml", via: "IM, IV lenta", frec: "Cada 8-12 h", duracion: "1 a 3 d√≠as", notas: "Eficaz en v√≥mitos severos. Uso 'off-label' en veterinaria.", efectoMin: "Control de n√°usea", efectoRec: "Control de v√≥mito", efectoMax: "V√≥mito incoercible" },
    { id: 4, nombre: "Bromhexina", principio: "Bromhexina HCl", aplicaA: "Perro,Gato,Caballo", caso: "Mucol√≠tico, expectorante", min: 0.2, rec: 0.2, max: 0.2, conc: 3, unidadConc: "mg/ml", via: "IM", frec: "Cada 12-24 h", duracion: "5 a 7 d√≠as", notas: "Incrementa el volumen de secreciones bronquiales.", efectoMin: "Expectorante", efectoRec: "Expectorante", efectoMax: "Expectorante" },
    { id: 5, nombre: "Buscapina Compositum", principio: "Butilhioscina/Metamizol", aplicaA: "Perro,Caballo", caso: "Espasmo y dolor (C√≥lico)", min: 0.5, rec: 0.5, max: 0.5, conc: 504, unidadConc: "mg/ml", via: "IM, IV lenta", frec: "Cada 8-12 h", duracion: "1 a 3 d√≠as", notas: "Dosis de 25mg/kg basada en Metamizol. CONTRAINDICADO EN GATOS.", efectoMin: "Antiespasm√≥dico", efectoRec: "Analg√©sico", efectoMax: "Analg√©sico" },
    { id: 6, nombre: "Carprofeno (Rimadyl)", principio: "Carprofeno", aplicaA: "Perro", caso: "Dolor e inflamaci√≥n", min: 4.4, rec: 4.4, max: 4.4, conc: 50, unidadConc: "mg/ml", via: "SC, IV", frec: "Cada 24 h", duracion: "3 a 5 d√≠as", notas: "CONTRAINDICADO EN GATOS. Riesgo gastrolesivo y hep√°tico. No usar con otros AINEs o corticoides.", efectoMin: "Alivio del dolor", efectoRec: "Alivio del dolor", efectoMax: "Alivio del dolor" },
    { id: 7, nombre: "Catosal", principio: "Butafosfan/Cianocobalamina", aplicaA: "Perro,Gato,Caballo,Borrego,Cabra", caso: "Estimulante metab√≥lico", min: 10, rec: 12.5, max: 15, conc: 100, unidadConc: "mg/ml", via: "IM, SC, IV", frec: "Cada 24 h", duracion: "3 a 5 d√≠as", notas: "Dosis basada en Butafosfan.", efectoMin: "T√≥nico", efectoRec: "Estimulante", efectoMax: "Crecimiento" },
    { id: 8, nombre: "Cefalax (Innofarma)", principio: "Cefalexina", aplicaA: "Perro,Gato", caso: "Infecciones", min: 22, rec: 22, max: 22, conc: 150, unidadConc: "mg/ml", via: "IM", frec: "Cada 12-24 h", duracion: "7 a 14 d√≠as (piel: 3-4 semanas)", notas: "Ajustar dosis en insuficiencia renal.", efectoMin: "Tratamiento", efectoRec: "Tratamiento", efectoMax: "Tratamiento" },
    { id: 9, nombre: "Cerenia", principio: "Maropitant", aplicaA: "Perro,Gato", caso: "V√≥mito agudo", min: 1, rec: 1, max: 1, conc: 10, unidadConc: "mg/ml", via: "SC, IV", frec: "Cada 24 h", duracion: "Hasta 5 d√≠as consecutivos", notas: "Para mareo por viaje en perros, usar presentaci√≥n en pastillas.", efectoMin: "Control del v√≥mito", efectoRec: "Control del v√≥mito", efectoMax: "Control del v√≥mito" },
    { id: 10, nombre: "Clindamicina", principio: "Clindamicina", aplicaA: "Perro,Gato", caso: "Infecciones por anaerobios", min: 5, rec: 10, max: 11, conc: 100, unidadConc: "mg/ml", via: "IM", frec: "Cada 12 h", duracion: "Piel: 2-4 sem. Hueso: 4-6 sem.", notas: "Excelente para infecciones de piel, hueso y dentales. Gatos requieren dosis m√°s altas.", efectoMin: "Tratamiento", efectoRec: "Tratamiento", efectoMax: "Tratamiento" },
    { id: 12, nombre: "Dexametasona", principio: "Dexametasona", aplicaA: "Perro,Gato,Caballo,Borrego,Cabra", caso: "Antiinflamatorio, Antial√©rgico", min: 0.05, rec: 0.1, max: 0.2, conc: 2, unidadConc: "mg/ml", via: "IM, SC, IV", frec: "Cada 24 h", duracion: "1 a 5 d√≠as (reducir gradualmente)", notas: "Usar la dosis m√≠nima efectiva por el menor tiempo posible.", efectoMin: "Antiinflamatorio", efectoRec: "Antial√©rgico", efectoMax: "Shock (dosis 2-4mg/kg)" },
    { id: 13, nombre: "Dipirona (Alnex)", principio: "Dipirona S√≥dica", aplicaA: "Perro,Caballo", caso: "Analg√©sico, Antipir√©tico", min: 22, rec: 25, max: 28, conc: 500, unidadConc: "mg/ml", via: "IM, SC, IV", frec: "Cada 8-12 h", duracion: "M√°ximo 3-5 d√≠as", notas: "Puede causar agranulocitosis. No usar en gatos.", efectoMin: "Antipir√©tico", efectoRec: "Analg√©sico", efectoMax: "Analg√©sico" },
    { id: 33, nombre: "Dipiran-500", principio: "Dipirona", aplicaA: "Perro,Caballo", caso: "Analg√©sico, Antipir√©tico", min: 22, rec: 25, max: 28, conc: 500, unidadConc: "mg/ml", via: "IM, SC, IV", frec: "Cada 8-12 h", duracion: "M√°ximo 3-5 d√≠as", notas: "Puede causar agranulocitosis. No usar en gatos.", efectoMin: "Antipir√©tico", efectoRec: "Analg√©sico", efectoMax: "Analg√©sico" },
    { id: 14, nombre: "Emetin Inyectable", principio: "Metoclopramida", aplicaA: "Perro,Gato", caso: "Antiem√©tico, procin√©tico", min: 0.1, rec: 0.1, max: 0.1, conc: 1, unidadConc: "ml/10kg", via: "IM", frec: "Cada 8 h", duracion: "1 a 3 d√≠as", notas: "La dosis es 0.1ml/kg. No confundir con Emetina (cardiot√≥xica).", efectoMin: "Control de n√°usea", efectoRec: "Control de v√≥mito", efectoMax: "Control de v√≥mito" },
    { id: 15, nombre: "Enrofloxacina (Piroflox)", principio: "Enrofloxacina", aplicaA: "Perro,Gato,Caballo,Borrego,Cabra", caso: "Bactericida", min: 5, rec: 7.5, max: 10, conc: 50, unidadConc: "mg/ml", via: "IM, SC", frec: "Cada 24 h", duracion: "5 a 10 d√≠as", notas: "No usar en cachorros (<1 a√±o) por riesgo de artropat√≠a. En gatos, no exceder 5mg/kg por riesgo de ceguera.", efectoMin: "Tratamiento", efectoRec: "Tratamiento", efectoMax: "Tratamiento" },
    { id: 16, nombre: "Extracto de H√≠gado", principio: "Complejo B", aplicaA: "Perro,Gato,Caballo,Borrego,Cabra", caso: "Deficiencias vitam√≠nicas", min: 1, rec: 3, max: 5, conc: 1, unidadConc: "ml/animal", via: "IM", frec: "2-3 veces/semana", duracion: "2 a 4 semanas", notas: "Dosis total por animal, no por kg. Perros/Gatos: 0.5-5ml. Grandes: 10-15ml.", efectoMin: "Soporte", efectoRec: "Tratamiento", efectoMax: "Tratamiento" },
    { id: 18, nombre: "Flumetasona", principio: "Flumetasona", aplicaA: "Perro,Gato,Caballo", caso: "Antiinflamatorio glucocorticoide", min: 0.06, rec: 0.15, max: 0.25, conc: 0.5, unidadConc: "mg/ml", via: "IM, SC, IV", frec: "Cada 24-48 h", duracion: "1 a 3 dosis", notas: "Potente corticoide. Usar con precauci√≥n.", efectoMin: "Antiinflamatorio", efectoRec: "Trastornos musculoesquel√©ticos", efectoMax: "Shock" },
    { id: 19, nombre: "Gentamicina", principio: "Gentamicina", aplicaA: "Perro,Gato,Caballo", caso: "Infecciones por Gram-", min: 6, rec: 8, max: 10, conc: 100, unidadConc: "mg/ml", via: "IV, IM, SC", frec: "Cada 24 h", duracion: "5 a 7 d√≠as", notas: "NEFROT√ìXICO y OTOT√ìXICO. Monitorear funci√≥n renal. No usar en animales de producci√≥n.", efectoMin: "Tratamiento", efectoRec: "Tratamiento", efectoMax: "Tratamiento" },
    { id: 20, nombre: "Histafin", principio: "Clorfenamina Maleato", aplicaA: "Perro,Gato,Caballo", caso: "Reacciones al√©rgicas", min: 0.5, rec: 1, max: 2, conc: 10, unidadConc: "mg/ml", via: "IM, SC, IV", frec: "Cada 8-12 h", duracion: "Seg√∫n respuesta (1-5 d√≠as)", notas: "Puede causar somnolencia.", efectoMin: "Dermatitis al√©rgica", efectoRec: "Anafilaxis", efectoMax: "Mastocitomas" },
    { id: 22, nombre: "Oxito-Zoo", principio: "Oxitocina", aplicaA: "Perro,Gato,Caballo,Borrego,Cabra", caso: "Estimulante uterino", min: 0.2, rec: 0.6, max: 1, conc: 1, unidadConc: "ml/animal", via: "IM, SC, IV", frec: "Dosis √önica", duracion: "Dosis √önica", notas: "Dosis total por animal. Usar con c√©rvix abierto.", efectoMin: "Bajada de leche", efectoRec: "Aceleraci√≥n del parto", efectoMax: "Inercia uterina" },
    { id: 23, nombre: "Penicilina G", principio: "Penicilina G Proca√≠nica", aplicaA: "Perro,Gato,Caballo,Borrego,Cabra", caso: "Infecciones por Gram+", min: 22000, rec: 30000, max: 44000, conc: 300000, unidadConc: "UI/ml", via: "IM", frec: "Cada 12-24 h", duracion: "5 a 7 d√≠as", notas: "Dosis en Unidades Internacionales (UI). ¬°NUNCA IV!", efectoMin: "Tratamiento", efectoRec: "Tratamiento", efectoMax: "Tratamiento" },
    { id: 24, nombre: "Prifinial", principio: "Bromuro de Prifinio", aplicaA: "Perro,Gato", caso: "Espasmos digestivos", min: 0.75, rec: 1, max: 1.25, conc: 7.5, unidadConc: "mg/ml", via: "IM, SC", frec: "Cada 12 h", duracion: "1 a 3 d√≠as", notas: "Para c√≥licos o dolor visceral. Gatos requieren dosis m√°s altas.", efectoMin: "Espasmo leve", efectoRec: "Espasmo moderado", efectoMax: "Espasmo severo" },
    { id: 26, nombre: "Ranitidina", principio: "Ranitidina", aplicaA: "Perro,Gato,Caballo", caso: "Gastritis, √∫lcera g√°strica", min: 2, rec: 3, max: 4, conc: 40, unidadConc: "mg/ml", via: "IM, IV lenta", frec: "Cada 8-12 h", duracion: "7 a 14 d√≠as", notas: "Reduce la producci√≥n de √°cido g√°strico.", efectoMin: "Prevenci√≥n", efectoRec: "Gastritis", efectoMax: "√ölcera activa" },
    { id: 34, nombre: "Respiren", principio: "Florfenicol", aplicaA: "Borrego,Cabra", caso: "Enfermedades bacterianas", min: 20, rec: 20, max: 20, conc: 300, unidadConc: "mg/ml", via: "IM", frec: "Cada 48 h", duracion: "2 dosis (una cada 48h)", notas: "Dosis de 20mg/kg (1ml/15kg). No usar en animales para reproducci√≥n.", efectoMin: "Tratamiento", efectoRec: "Tratamiento", efectoMax: "Tratamiento" },
    { id: 35, nombre: "Sulfas", principio: "Sulfa-Trimetoprim", aplicaA: "Perro,Gato,Caballo,Borrego,Cabra", caso: "Infecciones por g√©rmenes", min: 15, rec: 24, max: 30, conc: 240, unidadConc: "mg/ml", via: "IV, IM", frec: "Cada 12-24 h", duracion: "7 a 14 d√≠as", notas: "Riesgo de Queratoconjuntivitis Seca (KCS) en perros.", efectoMin: "Tratamiento", efectoRec: "Tratamiento", efectoMax: "Tratamiento" },
    { id: 36, nombre: "Virustad Halvet", principio: "Inmunoglobulinas", aplicaA: "Perro,Gato", caso: "Auxiliar en problemas virales", min: 0.1, rec: 0.1, max: 0.1, conc: 1, unidadConc: "ml/kg", via: "IM", frec: "Cada 24 h", duracion: "3 a 5 d√≠as", notas: "Dosis es 1ml por cada 10kg.", efectoMin: "Soporte viral", efectoRec: "Soporte viral", efectoMax: "Soporte viral" },
    { id: 30, nombre: "Vitamina K", principio: "Fitomenadiona (Vitamina K1)", aplicaA: "Perro,Gato", caso: "Intoxicaci√≥n por raticidas", min: 2.5, rec: 3.5, max: 5, conc: 10, unidadConc: "mg/ml", via: "SC", frec: "Cada 12 h", duracion: "3 a 4 semanas", notas: "Para intoxicaci√≥n por warfar√≠nicos. Evitar v√≠a IV por riesgo de anafilaxis.", efectoMin: "Mantenimiento", efectoRec: "Dosis inicial", efectoMax: "Dosis de ataque severa" },
    { id: 31, nombre: "Xilacina 10%", principio: "Xilacina", aplicaA: "Caballo", caso: "Sedante, analg√©sico", min: 0.5, rec: 0.8, max: 1.1, conc: 100, unidadConc: "mg/ml", via: "IM, IV", frec: "Dosis √önica", duracion: "Dosis √önica", notas: "Causa ataxia significativa. Monitorear frecuencia cardiaca.", efectoMin: "Sedaci√≥n ligera", efectoRec: "Sedaci√≥n profunda", efectoMax: "Pre-anestesia" },
    { id: 32, nombre: "Xilacina 10%", principio: "Xilacina", aplicaA: "Borrego,Cabra", caso: "Sedante, analg√©sico", min: 0.05, rec: 0.1, max: 0.22, conc: 100, unidadConc: "mg/ml", via: "IM", frec: "Dosis √önica", duracion: "Dosis √önica", notas: "¬°EXTREMA PRECAUCI√ìN! Rumiantes son 10 veces m√°s sensibles que los caballos. Usar dosis muy bajas.", efectoMin: "Sedaci√≥n ligera", efectoRec: "Sedaci√≥n profunda", efectoMax: "Inmovilizaci√≥n" },
    { id: 38, nombre: "Xilacina 10%", principio: "Xilacina", aplicaA: "Perro", caso: "Sedante, analg√©sico", min: 1, rec: 1.5, max: 2.2, conc: 100, unidadConc: "mg/ml", via: "IM", frec: "Dosis √önica", duracion: "Dosis √önica", notas: "Monitorear bradicardia y depresi√≥n respiratoria.", efectoMin: "Sedaci√≥n ligera", efectoRec: "Sedaci√≥n profunda", efectoMax: "Relajaci√≥n muscular" },
    { id: 39, nombre: "Xilacina 10%", principio: "Xilacina", aplicaA: "Gato", caso: "Sedante, em√©tico", min: 1.1, rec: 1.1, max: 2.2, conc: 100, unidadConc: "mg/ml", via: "IM", frec: "Dosis √önica", duracion: "Dosis √önica", notas: "Los gatos son sensibles. Dosis de 1.1mg/kg es efectiva como em√©tico.", efectoMin: "Emesis", efectoRec: "Emesis", efectoMax: "Sedaci√≥n" },
    { id: 37, nombre: "Zoletil", principio: "Tiletamina/Zolazepam", aplicaA: "Perro,Gato", caso: "Anestesia disociativa", min: 3, rec: 7, max: 15, conc: 50, unidadConc: "mg/ml", via: "IM", frec: "Dosis √önica", duracion: "Dosis √önica", notas: "La dosis depende de la profundidad anest√©sica deseada. Gatos: 10-15mg/kg. Perros: 7-10mg/kg.", efectoMin: "Inmovilizaci√≥n", efectoRec: "Anestesia corta", efectoMax: "Anestesia quir√∫rgica" }
];


// --- PARTE 2: La L√≥gica de la Calculadora ---
document.addEventListener('DOMContentLoaded', () => {
    const especieSelect = document.getElementById('especie');
    const pesoInput = document.getElementById('peso');
    const medicationsContainer = document.getElementById('medications-container');
    const modal = document.getElementById('gemini-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const closeModalBtn = document.getElementById('close-modal-btn');

    let medCounter = 0;
    const choicesInstances = {}; 

    // --- Gemini API Call ---
    async function callGeminiAPI(prompt, button) {
        button.disabled = true;
        button.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Generando...</span>`;
        
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            modalBody.innerHTML = text.replace(/\n/g, '<br>'); // Simple markdown
            modal.classList.remove('hidden');
        } catch (error) {
            modalBody.textContent = 'Error al generar la respuesta. Por favor, int√©ntelo de nuevo.';
            modal.classList.remove('hidden');
        } finally {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText;
        }
    }

    function createAddButton() {
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'pt-4';
        buttonContainer.innerHTML = `<button id="add-med-btn" class="w-full flex items-center justify-center gap-2 rounded-lg bg-indigo-600 px-4 py-2.5 text-base font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline">A√±adir Otro Medicamento</button>`;
        buttonContainer.querySelector('#add-med-btn').addEventListener('click', createMedicationSection);
        return buttonContainer;
    }

    function createMedicationSection() {
        medCounter++;
        const section = document.createElement('div');
        section.className = 'medication-section';
        section.id = `med-section-${medCounter}`;
        section.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="medicamento-${medCounter}" class="block text-sm font-medium text-slate-700">3. Tratamiento</label>
                    <select id="medicamento-${medCounter}" data-id="${medCounter}" class="medicamento-select mt-1"></select>
                </div>
                <div id="results-panel-${medCounter}" class="space-y-3 pt-2">
                    <div id="res-min-${medCounter}" class="result-card p-3 rounded-lg border"><p class="text-xs font-semibold uppercase text-yellow-800">Dosis M√≠nima</p><p id="res-min-val-${medCounter}" class="text-2xl font-bold text-yellow-900">-</p><p id="efecto-min-${medCounter}" class="text-sm text-slate-600 mt-1">-</p></div>
                    <div id="res-rec-${medCounter}" class="result-card p-3 rounded-lg border"><p class="text-xs font-semibold uppercase text-green-800">Dosis Recomendada</p><p id="res-rec-val-${medCounter}" class="text-2xl font-bold text-green-900">-</p><p id="efecto-rec-${medCounter}" class="text-sm text-slate-600 mt-1">-</p></div>
                    <div id="res-max-${medCounter}" class="result-card p-3 rounded-lg border"><p class="text-xs font-semibold uppercase text-red-800">Dosis M√°xima</p><p id="res-max-val-${medCounter}" class="text-2xl font-bold text-red-900">-</p><p id="efecto-max-${medCounter}" class="text-sm text-slate-600 mt-1">-</p></div>
                </div>
            </div>
            <div id="info-panel-${medCounter}" class="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-3 mt-4 hidden">
                 <div class="grid grid-cols-2 gap-4">
                    <div><h3 class="text-sm font-semibold text-slate-600">V√≠a de Administraci√≥n:</h3><p id="info-via-${medCounter}" class="text-base text-slate-800">-</p></div>
                    <div><h3 class="text-sm font-semibold text-slate-600">Frecuencia:</h3><p id="info-frecuencia-${medCounter}" class="text-base text-slate-800">-</p></div>
                 </div>
                 <div><h3 class="text-sm font-semibold text-slate-600">Duraci√≥n del Tratamiento:</h3><p id="info-duracion-${medCounter}" class="text-base text-slate-800">-</p></div>
                 <div class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-3 rounded-r-lg mt-2">
                    <h3 class="text-sm font-bold">Notas / Advertencias Importantes:</h3><p id="info-notas-${medCounter}" class="text-base mt-1">-</p>
                </div>
                <div id="gemini-buttons-${medCounter}" class="flex gap-2 pt-3">
                    <button data-id="${medCounter}" data-type="ficha" class="gemini-btn flex-1 flex items-center justify-center gap-2 rounded-md bg-slate-700 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-600">‚ú® Generar Ficha</button>
                    <button data-id="${medCounter}" data-type="cliente" class="gemini-btn flex-1 flex items-center justify-center gap-2 rounded-md bg-slate-700 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-600">‚ú® Explicaci√≥n Cliente</button>
                </div>
            </div>
        `;
        
        const oldButton = document.getElementById('add-med-btn-container');
        if(oldButton) oldButton.remove();
        
        medicationsContainer.appendChild(section);
        const newButton = createAddButton();
        newButton.id = 'add-med-btn-container';
        medicationsContainer.appendChild(newButton);

        const medSelect = document.getElementById(`medicamento-${medCounter}`);
        choicesInstances[medCounter] = new Choices(medSelect, { searchResultLimit: 15, itemSelectText: 'Seleccionar', placeholder: true, placeholderValue: 'Seleccione especie primero', sorter: (a, b) => a.label.localeCompare(b.label) });
        medSelect.addEventListener('change', () => calculateAndDisplay(medCounter));
        
        section.querySelectorAll('.gemini-btn').forEach(btn => {
            btn.dataset.originalText = btn.innerHTML;
            btn.addEventListener('click', handleGeminiClick);
        });

        updateTratamientosDropdown(medCounter);
    }

    function updateAllDropdowns() {
        Object.keys(choicesInstances).forEach(id => {
            updateTratamientosDropdown(id);
            calculateAndDisplay(id);
        });
    }

    function updateTratamientosDropdown(id) {
        const selectedEspecie = especieSelect.value;
        const choices = choicesInstances[id];
        choices.disable();
        choices.clearStore();

        if (!selectedEspecie) {
             choices.setChoices([{ value: '', label: 'Seleccione especie', disabled: true }]);
             return;
        };

        const protocolos = database.filter(item => item.aplicaA.includes(selectedEspecie));
        const choicesData = protocolos.map(item => ({ value: item.id, label: `${item.nombre} (${item.caso})` }));
        choices.enable();
        choices.setChoices([{ value: '', label: 'Seleccione o busque...', placeholder: true }, ...choicesData]);
    }

    function calculateAndDisplay(id) {
        const peso = parseFloat(pesoInput.value);
        const choices = choicesInstances[id];
        const protocolId = choices.getValue(true) ? parseInt(choices.getValue(true)) : null;
        
        const resMinVal = document.getElementById(`res-min-val-${id}`);
        const resRecVal = document.getElementById(`res-rec-val-${id}`);
        const resMaxVal = document.getElementById(`res-max-val-${id}`);
        const efectoMinEl = document.getElementById(`efecto-min-${id}`);
        const efectoRecEl = document.getElementById(`efecto-rec-${id}`);
        const efectoMaxEl = document.getElementById(`efecto-max-${id}`);
        const infoPanel = document.getElementById(`info-panel-${id}`);

        const resetSection = () => {
             [resMinVal, resRecVal, resMaxVal, efectoMinEl, efectoRecEl, efectoMaxEl].forEach(el => el.textContent = '-');
             [document.getElementById(`res-min-${id}`), document.getElementById(`res-rec-${id}`), document.getElementById(`res-max-${id}`)].forEach(el => { el.className = 'result-card p-3 rounded-lg border'; el.classList.remove('show'); });
            infoPanel.classList.add('hidden');
        }

        if (!peso || !protocolId || peso <= 0) { resetSection(); return; }
        const protocol = database.find(item => item.id === protocolId);
        if (!protocol) return;

        let minDose, recDose, maxDose;
        let unidad = 'ml';

        switch(protocol.unidadConc) {
            case 'ml/kg': minDose = peso * protocol.min; recDose = peso * protocol.rec; maxDose = peso * protocol.max; break;
            case 'ml/5kg': minDose = (peso / 5) * protocol.min; recDose = (peso / 5) * protocol.rec; maxDose = (peso / 5) * protocol.max; break;
            case 'ml/10kg': minDose = (peso / 10) * protocol.min; recDose = (peso / 10) * protocol.rec; maxDose = (peso / 10) * protocol.max; break;
            case 'ml/animal': minDose = protocol.min; recDose = protocol.rec; maxDose = protocol.max; break;
            default: minDose = (peso * protocol.min) / protocol.conc; recDose = (peso * protocol.rec) / protocol.conc; maxDose = (peso * protocol.max) / protocol.conc; break;
        }
        
        resMinVal.textContent = `${minDose.toFixed(2)} ${unidad}`;
        resRecVal.textContent = `${recDose.toFixed(2)} ${unidad}`;
        resMaxVal.textContent = `${maxDose.toFixed(2)} ${unidad}`;
        efectoMinEl.textContent = protocol.efectoMin;
        efectoRecEl.textContent = protocol.efectoRec;
        efectoMaxEl.textContent = protocol.efectoMax;

        ['min', 'rec', 'max'].forEach(type => document.getElementById(`res-${type}-${id}`).className = `result-card p-3 rounded-lg border bg-${type === 'min' ? 'yellow' : type === 'rec' ? 'green' : 'red'}-100 border-${type === 'min' ? 'yellow' : type === 'rec' ? 'green' : 'red'}-300 show`);
        
        document.getElementById(`info-via-${id}`).textContent = protocol.via;
        document.getElementById(`info-frecuencia-${id}`).textContent = protocol.frec;
        document.getElementById(`info-duracion-${id}`).textContent = protocol.duracion;
        document.getElementById(`info-notas-${id}`).textContent = protocol.notas;
        infoPanel.classList.remove('hidden');
    }
    
    function handleGeminiClick(event) {
        const button = event.currentTarget;
        const id = button.dataset.id;
        const type = button.dataset.type;
        const peso = parseFloat(pesoInput.value);
        const especie = especieSelect.value;
        const choices = choicesInstances[id];
        const protocolId = choices.getValue(true) ? parseInt(choices.getValue(true)) : null;

        if (!protocolId || !peso || !especie) {
            alert("Por favor, complete todos los campos primero.");
            return;
        }

        const protocol = database.find(item => item.id === protocolId);
        const dosisRec = ((peso * protocol.rec) / (protocol.conc || 1)).toFixed(2);
        
        let prompt = '';
        if (type === 'ficha') {
            modalTitle.textContent = `Ficha Farmacol√≥gica: ${protocol.principio}`;
            prompt = `Act√∫a como un farmac√≥logo veterinario experto. Proporciona una ficha t√©cnica concisa sobre el uso de ${protocol.principio} en un ${especie}. Incluye: 1. Mecanismo de acci√≥n. 2. Principales indicaciones. 3. Contraindicaciones y advertencias m√°s importantes para esta especie. 4. Efectos adversos comunes. S√© breve, profesional y directo.`;
        } else {
            modalTitle.textContent = `Explicaci√≥n para Cliente`;
            prompt = `Act√∫a como un veterinario comunic√°ndose con el due√±o de una mascota. Escribe una explicaci√≥n sencilla y clara sobre el medicamento ${protocol.nombre} que se le ha recetado a su ${especie} de ${peso} kg. Explica para qu√© sirve (${protocol.caso}), c√≥mo se administrar√° (${protocol.frec} por ${protocol.duracion}), y qu√© signos de alerta debe vigilar en casa. Usa un tono amigable y tranquilizador. La dosis calculada es ${dosisRec} ml.`;
        }
        
        callGeminiAPI(prompt, button);
    }
    
    // Event Listeners
    especieSelect.addEventListener('change', updateAllDropdowns);
    pesoInput.addEventListener('input', updateAllDropdowns);
    closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));

    // Initial state
    createMedicationSection(); 
});
</script>

</body>
</html>
